#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.13"
# dependencies = [
#     "python-dateutil",
# ]
# ///
# if given nothing, print the time
# if given the time, print the human time
# if given the human time, print the time

import argparse
import sys
from datetime import datetime

from dateutil import parser as dtp, tz


def isfloat(arg):
    """If only there was str.isfloat like str.isdigit"""
    try:
        float(arg)
        return True
    except ValueError:
        return False


def num_suffix(n):
    return 'th st nd rd'.split()[n%10<4 and n%100//10!=1 and n%10]


def format_date(dt, fmt, strftime):
    if fmt in (None, 'unixtime'):  # 1756833198.85659
        return dt.timestamp()
    elif fmt == 'full_iso':  # 2025-09-02T13:13:36.826109-04:00
        return dt.isoformat()
    elif fmt == 'iso':  # 2025-09-02 13:13:48
        return dt.strftime('%Y-%m-%d %H:%M:%S')
    elif fmt == 'date':  # 2025-09-02
        return dt.strftime('%Y-%m-%d')
    elif fmt == 'time':  # 13:13:48
        return dt.strftime('%H:%M:%S')
    elif fmt == 'rfc2822':  # Tue, 02 Sep 2025 13:14:32 -0400
        from email import utils
        return utils.format_datetime(dt)
    elif fmt == 'locale':  # Tue Sep  2 13:14:54 2025
        return dt.strftime('%c')
    elif fmt == 'strftime':
        return dt.strftime(strftime)
    elif fmt == 'full':  # "Tuesday, September 2nd 2025", impossible with 'date'
        return dt.strftime(f"%A, %B %-d{num_suffix(dt.day)} %Y")

    raise Exception(f"Unknown format option: {fmt}")


def main(arg, opts, utc):
    fmt = next((k for k, v in opts.items() if v), None)
    if not arg:
        dt = datetime.now(tz.tzutc() if utc else tz.tzlocal())
    elif isfloat(arg):
        dt = datetime.fromtimestamp(float(arg), tz.tzutc() if utc else tz.tzlocal())
        if not fmt:
            fmt = 'full_iso'
    else:
        dt = dtp.parse(arg)
        if dt.tzinfo is None:
            dt = dt.astimezone(tz.tzutc() if utc else tz.tzlocal())

    return format_date(dt, fmt, opts['strftime'])


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Show/convert timestamp')
    parser.add_argument('arg', nargs='*', help='Timestamp')
    parser.add_argument('-U', '--utc', action='store_true', help='use UTC')
    group = parser.add_mutually_exclusive_group()
    group.add_argument('-u', '--unixtime', action='store_true',
        help='unix timestamp (default if no arg or human arg)')
    group.add_argument('-i', '--iso', action='store_true', help='short iso')
    group.add_argument('-I', '--full_iso', action='store_true',
        help='full iso (default if timestamp arg)')
    group.add_argument('-r', '--rfc2822', action='store_true', help='rfc2822 (email)')
    group.add_argument('-l', '-c', '--locale', action='store_true', help='locale')
    group.add_argument('-s', '--strftime', metavar="S", help='Use strftime format string')
    group.add_argument('-f', '--full', action='store_true', help='Full English date')
    group.add_argument('-t', '--time', action='store_true', help='Time portion of iso date/time')
    group.add_argument('-d', '--date', action='store_true', help='Date portion of iso date/time')
    args = vars(parser.parse_args())

    # pick out primary arguments and pass format options
    arg = ' '.join(args.pop('arg'))
    utc = args.pop('utc')

    try:
        result = main(arg, args, utc)
        print(result)
    except Exception as e:
        print(repr(e))
        sys.exit(1)
