#!/usr/bin/env python3
import argparse
import logging

from aush import (
    cd,
    direnv,
    django_admin,
    echo,
    git,
    ln,
    mkdir,
    poetry,
    python3,
    t,
)

logging.basicConfig(level=logging.INFO)

# parse args
parser = argparse.ArgumentParser(description="Start a Python project")
parser.add_argument("name", help="The name of the project")
parser.add_argument("-d", "--django", action="store_true", help="Add Django to the project")
args = parser.parse_args()

# create directory
mkdir("-p", args.name)
cd(args.name)

# initialize poetry with default dependencies, create virtualenv
poetry.init(
    no_interaction = True,
    name = args.name,
    author = git.config(get='user.name'),
    dev_dependency = [
        'pytest', 'ipython', 'ptpython', 'pylint', 'mypy', 'black', 'pudb'
    ],
)
poetry.install()

# set up direnv
echo("layout poetry") > '.envrc'
direnv.allow()

# add files to git
git.init()
echo('\n'.join(('*.sqlite3', '*.db', '.venv/', '__pycache__/'))) > '.gitignore'
echo(f"# {args.name}") > 'README.md'
git.add(all=True, force=True)
git.commit(m="Initial commit")

if args.django:
    # add django
    poetry.add("django", dev=["Werkzeug", "django-debug-toolbar", "django-extensions"])
    django_admin.startproject(args.name)
    cd(args.name)
    django_manage = python3["manage.py"]
    django_manage.startapp(f"{args.name}_app")
    django_manage.migrate()
    django_manage.createsuperuser(
        noinput = True,
        username = "admin",
        email = git.config(get='user.email') or 'admin@localhost',
        _env = dict(DJANGO_SUPERUSER_PASSWORD='admin'),
    )
    git.add(all=True, force=True)
    git.commit(m="Add Django")
else:
    # create project structure
    # .
    # ├── README.md
    # ├── bin
    # │   └── proj -> ../proj
    # ├── poetry.lock
    # ├── proj
    # │   └── __init__.py
    # ├── pyproject.toml
    # └── tests
    #     └── __init__.py
    t(f'{args.name}/__init__.py', 'tests/__init__.py', 'bin/')
    ln('-s', f'../{args.name}', f'bin/{args.name}')  # create package symlink
    echo(args.name) > 'bin/.gitignore'  # add package symlink to gitignore
    git.add(all=True, force=True)
    git.commit(m="Create project structure")
