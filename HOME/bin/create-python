#!/usr/bin/env python3
import argparse
import logging
from os import chdir as cd

from aush import direnv, django_admin, echo, git, mkdir, poetry, python3

logging.basicConfig(level=logging.INFO)

# parse args
parser = argparse.ArgumentParser(description="Start a Python project")
parser.add_argument("name", help="The name of the project")
parser.add_argument("-d", "--django", action="store_true", help="Add Django to the project")
args = parser.parse_args()

# create directory
mkdir("-p", args.name)
cd(args.name)

# initialize poetry with default dependencies, create virtualenv
poetry.init(
    no_interaction = True,
    name = args.name,
    author = git.config(get='user.name'),
    dev_dependency = ['pytest', 'ipython', 'pylint', 'mypy', 'black', 'pudb'],
)
poetry.install()

# set up direnv
echo("layout poetry") > '.envrc'
direnv.allow()

# add files to git
git.init()
echo("*.sqlite3") > '.gitignore'
git.add(all=True)
git.commit(m="Initial commit")

# add django
if args.django:
    poetry.add("django", dev=["Werkzeug", "django-debug-toolbar", "django-extensions"])
    django_admin.startproject("src")
    cd("src")
    django_manage = python3["manage.py"]
    django_manage.startapp(args.name)
    django_manage.migrate()
    django_manage.createsuperuser(
        noinput = True,
        username = "admin",
        email = git.config(get='user.email'),
        _env = dict(DJANGO_SUPERUSER_PASSWORD='admin'),
    )
    git.add(all=True)
    git.commit(m="Add Django")
