#!/usr/bin/env python3
# idea from: https://github.com/DanielFGray/fzf-scripts/blob/master/fzrepl
import argparse
import re
import sys
from pathlib import Path
from subprocess import PIPE, run
from tempfile import NamedTemporaryFile

CONFIG_DIR = Path.home() / '.config/fzr'
HISTORY_DIR = CONFIG_DIR / 'history'


def get_history_path(parent_dir, cmd):
    # strip and replace anything but [a-zA-Z0-9_-]+ with a single underscore
    history_filename = re.sub(r'[^\w-]+', '_', cmd.strip(), re.ASCII)
    return parent_dir / history_filename


def get_fzr_cmd(cmd, temp_path, history_path):
    if '{}' not in cmd:
        cmd += ' {}'

    cmd = cmd.replace('{}', '{q}')
    return [
        'fzf',
        '--sync',
        '--ansi',
        '--read0',
        '--no-info',
        '--disabled',
        '--height=100%',
        '--print-query',
        '--header', cmd,
        '--history', history_path,
        '--preview', f"{cmd} <{temp_path}",
        '--preview-window=down,99%',
        '--bind=ctrl-r:refresh-preview',
        '--bind=up:previous-history,down:next-history',
        '--bind=alt-left:backward-word,alt-right:forward-word',
        f'--bind=ctrl-t:execute-silent({cmd} <{temp_path} | code -)',
        f'--bind=ctrl-c:execute-silent({cmd} <{temp_path} | cb)',
    ]


def command(value):
    if not value:
        raise ValueError("Command cannot be blank")
    return value


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="Interactive fzf repl")
    parser.add_argument('command', type=command)
    args = parser.parse_args()

    if not HISTORY_DIR.exists():
        HISTORY_DIR.mkdir(parents=True)

    history_path = get_history_path(HISTORY_DIR, args.command)

    with NamedTemporaryFile('w') as tmp:
        cmd = get_fzr_cmd(args.command, tmp.name, history_path)
        tmp.write(sys.stdin.read())
        tmp.seek(0)
        result = run(cmd, stdin=tmp, stdout=PIPE, text=True)
        if i := result.returncode:
            sys.exit((i ^ 130) and i)  # 130 from fzf means "cancelled"

        # print command & query (fzf --print-query)
        print(args.command, repr(result.stdout.splitlines()[0]))

        # remove adjacent duplicates in the history file
        run(f'echo "$(uniq {history_path})" > {history_path}', shell=True)
