#!/usr/local/bin/python3
# ^ intentionally use system Python vs /usr/bin/env
import code
import functools
import logging
import os
import subprocess
from contextlib import contextmanager
from pathlib import Path

import click

from lib import setup
from lib.mac import restart_os_functions
from lib.setup import packages

log = logging.getLogger()

@click.group(chain=True)
@click.option("-d", "--debug", is_flag=True, help="Enable debug logging")
def cli(debug):
    # set up logging
    loglevel = logging.DEBUG if debug else logging.INFO
    logging.basicConfig(level=loglevel)
    logging.getLogger('requests').setLevel(logging.WARNING)


@cli.command()
def debug():
    """Start an interactive console"""
    local = {**globals(), 'settings': SETTINGS}
    code.interact(local=local)


@contextmanager
def chdir(dir: Path):
    original = os.getcwd()
    os.chdir(dir)
    try:
        yield
    finally:
        os.chdir(original)


@cli.command()
@click.argument("files", nargs=-1, required=True)
def bless(files):
    """'Bless' files; "bless" means to put a file on the system somewhere
    under the control of 'setup', i.e. in the repository."""
    for file in files:
        with chdir(ORIGINAL_CWD):  # resolve relative paths relative to the original cwd
            dest_dir = setup.home() / Path(file).resolve().relative_to(Path.home())
        log.debug(f"Ensuring parent destination dir {dest_dir} exists")
        dest_dir.mkdir(parents=True, exist_ok=True)

        cmd = ['symgr', file, dest_dir]
        log.debug(f"Executing {cmd}")
        subprocess.run(cmd, check=True, cwd=ORIGINAL_CWD)


if __name__ == '__main__':
    # manipulate cwd and load settings
    ORIGINAL_CWD = os.getcwd()
    os.chdir(setup.root())  # set the cwd to the root of the repository
    SETTINGS = setup.load_config()

    # dynamically add options to the cli
    for name, settings in SETTINGS.items():
        func = functools.partial(packages.install, name, settings)
        func.__doc__ = settings.get('help', f"Setup {name}")
        cli.command(name)(func)

    cli()
