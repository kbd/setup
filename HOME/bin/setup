#!/usr/bin/env python3
import code
import functools
import logging
import os
import subprocess
from pathlib import Path

import click

from lib import setup
from lib.mac import restart_os_functions
from lib.setup import packages

log = logging.getLogger()

@click.group(chain=True)
@click.option("-d", "--debug", is_flag=True, help="Enable debug logging")
def cli(debug):
    # set up logging
    loglevel = logging.DEBUG if debug else logging.INFO
    logging.basicConfig(level=loglevel)
    logging.getLogger('requests').setLevel(logging.WARNING)


@cli.command()
def debug():
    """Start an interactive console"""
    local = {**globals(), 'settings': SETTINGS}
    code.interact(local=local)


@cli.command()
def restart_os_funcs():
    """Restart Finder, Menubar, Dock, etc."""
    restart_os_functions()


@cli.command()
@click.argument("files", nargs=-1, required=True)
def bless(files):
    """'Bless' files; "bless" means to put a file on the system somewhere
    under the control of 'setup', i.e. in the repository."""
    for file in files:
        dest_dir = setup.home() / Path(ORIGINAL_CWD).relative_to(Path.home())
        log.debug(f"Ensuring parent destination dir {dest_dir} exists")
        dest_dir.mkdir(parents=True, exist_ok=True)

        cmd = ['symgr', file, dest_dir]
        log.debug(f"Executing {cmd}")
        subprocess.run(cmd, check=True, cwd=ORIGINAL_CWD)


if __name__ == '__main__':
    # manipulate cwd and load settings
    ORIGINAL_CWD = os.getcwd()
    os.chdir(setup.root())  # set the cwd to the root of the repository
    SETTINGS = setup.load_config()

    # dynamically add options to the cli
    for name in SETTINGS.keys():
        func = functools.partial(packages.install, name, SETTINGS[name])
        func.__doc__ = SETTINGS[name].get('help', f"Setup {name}")
        cli.command(name)(func)

    cli()
