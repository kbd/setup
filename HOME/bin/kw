#!/usr/bin/env python3
# kw = "kitty window"
# open a new kitty window with the provided command and wait for it to complete
import functools
import json
import subprocess
import sys

TAIL = 'gtail'  # gnu tail

def find_window_pid(kitty_ls_windows, id):
    for os_window in kitty_ls_windows:
        for tab in os_window['tabs']:
            for window in tab['windows']:
                if window['id'] == id:
                    return window['pid']

run = functools.partial(subprocess.run, capture_output=True, check=True)

if __name__ == '__main__':
    cmd = ['kitty', '@', 'launch', '--cwd', 'current', '--copy-env', '--', *sys.argv[1:]]
    wid = int(run(cmd).stdout)
    ls = json.loads(run(['kitty', '@', 'ls']).stdout)
    pid = find_window_pid(ls, wid)
    # https://stackoverflow.com/a/41613532
    subprocess.run([TAIL, '--pid', str(pid), '-f', '/dev/null'])
